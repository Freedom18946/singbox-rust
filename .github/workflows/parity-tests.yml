name: parity-tests

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    # Run weekly to catch regressions
    - cron: '0 0 * * 0'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  route-explain-parity:
    name: Route Explain Parity (Rust vs Go)
    runs-on: ubuntu-latest
    if: false  # Disabled until Go sing-box binary is available in CI
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.82.0
          override: true

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2

      - name: Build Rust CLI
        run: cargo build --features router,explain

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # TODO: Download or build Go sing-box binary
      # - name: Setup Go sing-box
      #   run: |
      #     wget https://github.com/SagerNet/sing-box/releases/download/v1.12.12/sing-box-1.12.12-linux-amd64.tar.gz
      #     tar -xzf sing-box-1.12.12-linux-amd64.tar.gz
      #     export GO_SINGBOX="$PWD/sing-box-1.12.12-linux-amd64/sing-box"

      - name: Run parity tests
        run: |
          # Create test config
          cat > test_config.json <<'EOF'
          {
            "inbounds": [{ "type": "http", "listen": "127.0.0.1", "port": 18081 }],
            "outbounds": [
              { "type": "direct", "tag": "direct" },
              { "type": "block", "tag": "block" }
            ],
            "route": {
              "rules": [
                { "domain_suffix": ["example.com"], "outbound": "direct" },
                { "domain_suffix": ["blocked.com"], "outbound": "block" }
              ],
              "default": "direct"
            }
          }
          EOF

          # Test multiple destinations
          ./scripts/route_explain_parity.sh --ci test_config.json example.com:443
          ./scripts/route_explain_parity.sh --ci test_config.json blocked.com:443
          ./scripts/route_explain_parity.sh --ci test_config.json random.org:443

  geodata-parity:
    name: Geodata Parity (Rust vs Go)
    runs-on: ubuntu-latest
    if: false  # Disabled until Go sing-box binary is available in CI
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.82.0
          override: true

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2

      - name: Build Rust CLI
        run: cargo build --features router

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # TODO: Download geodata databases
      # - name: Download geodata
      #   run: |
      #     mkdir -p geodata
      #     wget -O geodata/geoip.db https://github.com/SagerNet/sing-geoip/releases/latest/download/geoip.db
      #     wget -O geodata/geosite.db https://github.com/SagerNet/sing-geosite/releases/latest/download/geosite.db

      - name: Run geodata parity tests
        run: |
          # Test geoip queries
          ./scripts/geodata_parity.sh --ci geoip cn:8.8.8.8
          ./scripts/geodata_parity.sh --ci geoip cn:114.114.114.114

          # Test geosite queries
          ./scripts/geodata_parity.sh --ci geosite google:youtube.com
          ./scripts/geodata_parity.sh --ci geosite cn:baidu.com

  adapter-smoke:
    name: Adapter Smoke Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        adapter: [http, socks, mixed, tuic, hysteria2]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.82.0
          override: true

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2

      - name: Run adapter smoke test for ${{ matrix.adapter }}
        run: |
          case "${{ matrix.adapter }}" in
            http|socks|mixed)
              cargo test --features adapters,adapter-${{ matrix.adapter }} test_${{ matrix.adapter }}_adapter
              ;;
            tuic)
              cargo test --features adapters,out_tuic test_tuic_adapter
              ;;
            hysteria2)
              cargo test --features adapters,out_hysteria2 test_hysteria2_adapter
              ;;
          esac
