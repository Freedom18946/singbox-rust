# L2.8 ConnectionTracker + è¿æ¥é¢æ¿ â€” ç¼ºå£åˆ†æ

> **ç”¨é€”**: L2.8 å®æ–½å‰ç½®åˆ†æï¼ŒGo vs Rust å®Œæ•´å¯¹æ¯”
> **ç”Ÿæˆæ—¥æœŸ**: 2026-02-08
> **å®æ–½çŠ¶æ€**: å¾…åš
> **ç›¸å…³ Go æºç **: `go_fork_source/sing-box-1.12.14/`
> **Parity é¢„ä¼°**: 92% â†’ 93%

---

## ä¸€ã€Go å‚è€ƒå®ç°æ¦‚è¦

### 1.1 ä¸‰å±‚æ¶æ„

Go è¿æ¥è·Ÿè¸ªæ¶‰åŠä¸‰ä¸ªç‹¬ç«‹å±‚ï¼š

| å±‚ | ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|----|------|------|------|
| L1 | `conntrack` (OS çº§) | `common/conntrack/` | å…¨å±€è¿æ¥åˆ—è¡¨ï¼ŒOOM kill switchï¼ˆbuild-tag ä¿æŠ¤ï¼Œå¯é€‰ï¼‰ |
| L2 | `trafficontrol.Manager` | `experimental/clashapi/trafficontrol/` | Clash API è¿æ¥è¿½è¸ª + æµé‡ç»Ÿè®¡ |
| L3 | `route.ConnectionManager` | `route/` | åŒå‘æ•°æ®æ‹·è´ / è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç† |

æ•°æ®æµ:
```
Inbound â†’ Router.routeConnection()
            â”‚
            â”œâ”€ conntrack.KillerCheck()         // L1: OOM ä¿æŠ¤ï¼ˆå¯é€‰ï¼‰
            â”‚
            â”œâ”€ matchRule() â†’ selectedOutbound
            â”‚
            â”œâ”€ for _, tracker := range r.trackers:
            â”‚     conn = tracker.RoutedConnection(conn, metadata, rule, outbound)
            â”‚                                    // L2: åŒ…è£…è¿æ¥åŠ è®¡æ•°å™¨
            â”‚
            â””â”€ connectionManager.NewConnection() // L3: å»ºè¿ + åŒå‘æ‹·è´
```

### 1.2 æ ¸å¿ƒæ¥å£

#### ConnectionTrackerï¼ˆè¿æ¥åŒ…è£…æ¥å£ï¼‰

```go
// adapter/router.go
type ConnectionTracker interface {
    RoutedConnection(ctx, conn, metadata, matchedRule, matchOutbound) net.Conn
    RoutedPacketConnection(ctx, conn, metadata, matchedRule, matchOutbound) N.PacketConn
}
```

Router éå†æ‰€æœ‰æ³¨å†Œçš„ trackerï¼Œæ¯ä¸ª tracker ç”¨è®¡æ•° wrapper åŒ…è£…è¿æ¥ï¼š
```go
for _, tracker := range r.trackers {
    conn = tracker.RoutedConnection(ctx, conn, metadata, selectedRule, selectedOutbound)
}
```

ClashServer å’Œ V2RayStatsService éƒ½å®ç°æ­¤æ¥å£ã€‚

#### ConnectionManagerï¼ˆè¿æ¥ç”Ÿå‘½å‘¨æœŸï¼‰

```go
// adapter/connections.go
type ConnectionManager interface {
    Lifecycle
    NewConnection(ctx, dialer, conn, metadata, onClose)
    NewPacketConnection(ctx, dialer, conn, metadata, onClose)
}
```

### 1.3 TrackerMetadata ç»“æ„

```go
// trafficontrol/tracker.go
type TrackerMetadata struct {
    ID           uuid.UUID
    Metadata     adapter.InboundContext
    CreatedAt    time.Time
    ClosedAt     time.Time
    Upload       *atomic.Int64
    Download     *atomic.Int64
    Chain        []string
    Rule         adapter.Rule
    Outbound     string
    OutboundType string
}
```

å…³é”®ç‰¹å¾:
- **Upload/Download**: åŸå­è®¡æ•°å™¨ï¼Œä¸ counter-wrapped conn å…±äº«å¼•ç”¨
- **Chain**: ä» matched outbound èµ°åˆ° leafï¼ˆvia `OutboundGroup.Now()`ï¼‰ï¼Œç„¶å**åè½¬**
- **ClosedAt**: è¿æ¥å…³é—­æ—¶ç”± `Leave()` è®¾ç½®

### 1.4 trafficontrol.Manager ç»“æ„

```go
// trafficontrol/manager.go
type Manager struct {
    uploadTotal   atomic.Int64       // å…¨å±€ç´¯è®¡ä¸Šä¼ 
    downloadTotal atomic.Int64       // å…¨å±€ç´¯è®¡ä¸‹è½½
    connections   compatible.Map[uuid.UUID, Tracker]  // æ´»è·ƒè¿æ¥ (sync.Map)
    closedConnections list.List[TrackerMetadata]       // å·²å…³é—­è¿æ¥ï¼Œä¸Šé™ 1000 (FIFO)
    memory        uint64
}
```

æ ¸å¿ƒæ–¹æ³•:
- `Join(tracker)`: æ³¨å†Œæ´»è·ƒè¿æ¥
- `Leave(tracker)`: ç§»å…¥ closedConnectionsï¼ˆcap=1000ï¼‰ï¼Œè®¾ç½® ClosedAt
- `Snapshot()`: è¿”å› `{downloadTotal, uploadTotal, connections[], memory}` â€” **è¿‡æ»¤ DNS ç±»å‹è¿æ¥**
- `PushUploaded(n)` / `PushDownloaded(n)`: ç´¯åŠ å…¨å±€è®¡æ•°
- `Total() â†’ (up, down)`: è¯»å–å…¨å±€è®¡æ•°

### 1.5 per-connection å­—èŠ‚è®¡æ•°

```go
// tracker.go â€” NewTCPTracker
ExtendedConn: bufio.NewCounterConn(conn, []N.CountFunc{func(n int64) {
    upload.Add(n)           // per-connection
    manager.PushUploaded(n) // å…¨å±€
}}, []N.CountFunc{func(n int64) {
    download.Add(n)           // per-connection
    manager.PushDownloaded(n) // å…¨å±€
}})
```

æ¯æ¬¡ read/write è§¦å‘**ä¸¤ä¸ªåŸå­åŠ **ï¼šper-connection + å…¨å±€ã€‚

æ–¹å‘è¯­ä¹‰:
- **Upload** = ä» inbound è¯»å–çš„å­—èŠ‚ï¼ˆå®¢æˆ·ç«¯ â†’ ä»£ç†ï¼‰
- **Download** = å†™å…¥ inbound çš„å­—èŠ‚ï¼ˆä»£ç† â†’ å®¢æˆ·ç«¯ï¼‰

### 1.6 Chain æ„å»ºé€»è¾‘

```go
// tracker.go
next = matchOutbound.Tag()   // æˆ– outboundManager.Default().Tag()
for {
    detour, loaded := outboundManager.Outbound(next)
    if !loaded { break }
    chain = append(chain, next)
    group, isGroup := detour.(adapter.OutboundGroup)
    if !isGroup { break }
    next = group.Now()
}
common.Reverse(chain)  // [matchedâ†’...â†’leaf] å˜ä¸º [leafâ†’...â†’matched]
```

### 1.7 Snapshot JSON Schema

**é¡¶å±‚:**
```json
{
    "downloadTotal": 123456,     // int64, å…¨å±€ç´¯è®¡
    "uploadTotal": 789012,       // int64, å…¨å±€ç´¯è®¡
    "connections": [...],        // TrackerMetadata æ•°ç»„
    "memory": 52428800           // uint64, Go runtime å†…å­˜
}
```

**æ¯ä¸ª connection:**
```json
{
    "id": "uuid-v4-string",
    "metadata": {
        "network": "tcp",
        "type": "mixed/mixed-in",
        "sourceIP": "192.168.1.100",
        "sourcePort": "12345",         // å­—ç¬¦ä¸²ï¼
        "destinationIP": "1.2.3.4",
        "destinationPort": "443",      // å­—ç¬¦ä¸²ï¼
        "host": "example.com",
        "dnsMode": "normal",           // å§‹ç»ˆ "normal"
        "processPath": "/usr/bin/curl"
    },
    "upload": 1024,
    "download": 4096,
    "start": "2024-01-01T00:00:00Z",   // RFC3339
    "chains": ["proxy", "selector"],    // åè½¬åçš„ chain
    "rule": "domain_suffix(example.com) => route(proxy)",
    "rulePayload": ""                   // å§‹ç»ˆç©ºå­—ç¬¦ä¸²
}
```

### 1.8 /traffic WebSocket

å‘é€**æ¯ç§’ delta**ï¼ˆä¸æ˜¯ç»å¯¹å€¼ï¼‰:
```go
tick := time.NewTicker(time.Second)
uploadTotal, downloadTotal := trafficManager.Total()
for range tick.C {
    newUp, newDown := trafficManager.Total()
    write(Traffic{Up: newUp - uploadTotal, Down: newDown - downloadTotal})
    uploadTotal, downloadTotal = newUp, newDown
}
```

æ ¼å¼: `{"up": <bytes_per_second>, "down": <bytes_per_second>}`

### 1.9 /connections WebSocket

æ¯ç§’æ¨é€å®Œæ•´ Snapshotï¼š
```go
tick := time.NewTicker(1000ms)  // å¯é€šè¿‡ ?interval= å‚æ•°è°ƒæ•´
for range tick.C {
    snapshot := trafficManager.Snapshot()
    write(snapshot)
}
```

HTTP è¯·æ±‚ï¼ˆæ—  WS Upgradeï¼‰ç›´æ¥è¿”å›å•æ¬¡ Snapshotã€‚

### 1.10 è¿æ¥å…³é—­

**DELETE /connections/:id**: éå† snapshot æ‰¾åˆ°åŒ¹é… UUIDï¼Œè°ƒç”¨ `tracker.Close()`ï¼ˆå…ˆ `Leave()` å†å…³ socketï¼‰ï¼Œ**å§‹ç»ˆ 204**ã€‚

**DELETE /connections**: å…³é—­æ‰€æœ‰è¿æ¥ + `router.ResetNetwork()`ã€‚

### 1.11 Wiring

```go
// box.go
clashServer := experimental.NewClashServer(...)
router.AppendTracker(clashServer)  // æ³¨å†Œä¸º ConnectionTracker
```

---

## äºŒã€GUI.for å‰ç«¯æœŸæœ›

### 2.1 TypeScript ç±»å‹

```typescript
// kernel.d.ts
interface CoreApiConnectionsData {
    memory: number
    uploadTotal: number
    downloadTotal: number
    connections: {
        chains: string[]
        download: number
        id: string
        metadata: {
            destinationIP: string
            destinationPort: string
            dnsMode: string
            host: string
            network: string
            processPath: string
            sourceIP: string
            sourcePort: string
            type: string
        }
        rule: string
        rulePayload: string
        start: string
        upload: number
    }[]
}
```

### 2.2 WebSocket è¡Œä¸º

GUI æ‰“å¼€ 3 ä¸ªé•¿æ´» WebSocket: `/memory`, `/traffic`, `/connections`ã€‚
- `/connections` WebSocket æ¨é€å®Œæ•´ `CoreApiConnectionsData` å¿«ç…§
- GUI é€šè¿‡ diff è¿ç»­å¿«ç…§æ£€æµ‹æ–­å¼€çš„è¿æ¥ï¼ˆå‰ä¸€ä¸ª snapshot æœ‰ã€å½“å‰æ²¡æœ‰ â†’ ç§»å…¥ "Closed" æ ‡ç­¾é¡µï¼‰
- GUI åœ¨å®¢æˆ·ç«¯è®¡ç®— per-connection é€Ÿç‡: `speed = current.upload - previous.upload`

### 2.3 UI æ¸²æŸ“ (12 åˆ—)

| åˆ— | æ•°æ®æ¥æº | æ˜¾ç¤ºé€»è¾‘ |
|----|---------|---------|
| Type | `metadata.type` | `{type}({network})` |
| Process Path | `metadata.processPath` | åŸæ · |
| Host | `metadata.host` | ç©ºæ—¶ fallback åˆ° `metadata.destinationIP` |
| Source | `metadata.sourceIP` | `{sourceIP}:{sourcePort}` |
| Destination IP | `metadata.destinationIP` | `{destinationIP}:{destinationPort}` |
| Rule | `rule` | `{rule}::{rulePayload}` |
| Chains | `chains` | åè½¬åç”¨ ` :: ` è¿æ¥ |
| UL Speed | computed | `record.upload - record.up` (delta) |
| DL Speed | computed | `record.download - record.down` (delta) |
| Upload | `upload` | æ€»å­—èŠ‚æ•° |
| Download | `download` | æ€»å­—èŠ‚æ•° |
| Time | `start` | `formatRelativeTime()` â€” å¿…é¡»æ˜¯å¯è§£æçš„æ—¥æœŸ |

### 2.4 GUI å…³é”®è¡Œä¸º

1. **ä»£ç†åˆ‡æ¢æ—¶è‡ªåŠ¨å…³é—­è¿æ¥**: `GET /connections` â†’ è¿‡æ»¤ `chains` å« group name çš„ â†’ `DELETE /connections/{id}` é€ä¸ªå…³é—­
2. **æ¨¡å¼åˆ‡æ¢æ—¶å…¨éƒ¨å…³é—­**: è°ƒç”¨ `DELETE /connections/{id}` é€ä¸ªï¼ˆä¸æ˜¯ `DELETE /connections`ï¼‰
3. **`start` æ ¼å¼**: å¿…é¡»æ˜¯ ISO 8601 æˆ–æ•°å­—æ—¶é—´æˆ³ï¼ˆå½“å‰ Rust è¿”å› Unix ms å­—ç¬¦ä¸² `"1705312200000"` åœ¨æŸäº› JS å¼•æ“ä¸Š `new Date("1705312200000")` è¿”å› Invalid Dateï¼‰

---

## ä¸‰ã€Rust å½“å‰å®ç°çŠ¶æ€

### 3.1 çŠ¶æ€æ€»è§ˆ

| ç»„ä»¶ | çŠ¶æ€ | è¯¦æƒ… |
|------|------|------|
| **API types** (`Connection`, `ConnectionMetadata`) | âœ… ç»“æ„æ­£ç¡® | ä¸ Go JSON æ ¼å¼åŸºæœ¬å¯¹é½ |
| **API `ConnectionManager`** (`sb-api/managers.rs`) | ğŸ”´ å­˜åœ¨ä½†æœªæ¥å…¥ | HashMap + atomic countersï¼Œä½† `add_connection()` ä»æœªè¢«è°ƒç”¨ |
| **`/connections` GET** | ğŸ”´ å§‹ç»ˆè¿”å›ç©º | `state.connection_manager` å§‹ç»ˆ `None` |
| **`/connections/:id` DELETE** | ğŸ”´ ä»…åˆ  HashMap | ä¸å…³é—­çœŸå® socket |
| **`/connections` DELETE** | ğŸ”´ ä»…æ¸…ç©º HashMap | ä¸å…³é—­çœŸå® socket |
| **`/connections` WebSocket** | ğŸ”´ å®Œå…¨ stub | `upgrade_connections()` è¿”å›é™æ€ JSON |
| **`/traffic` WebSocket** | ğŸ”´ å‘é€ mock æ•°æ® | ç¡¬ç¼–ç  +1000/+4000 æ¯ç§’ |
| **`/meta/memory` WebSocket** | âœ… Linux çœŸå® | è¯» `/proc/self/statm`; macOS è¿”å› 0 |
| **RouteConnectionManager** (`router/conn.rs`) | âœ… çœŸå®è¿æ¥å¤„ç† | dial + åŒå‘æ‹·è´ï¼Œä½†ä¸æš´éœ²ç»™ API å±‚ |
| **Context ConnectionManager** (`context.rs`) | ğŸ”´ å­˜åœ¨ä½†æœªæ¥å…¥ | `DashMap<u64, ConnectionInfo>`ï¼Œ`register()` æ— äººè°ƒç”¨ |
| **ConnTracker** (`sb-common/conntrack.rs`) | ğŸ”´ å­˜åœ¨ä½†æœªä½¿ç”¨ | å®Œå–„å®ç°ï¼Œ`global_tracker()` æ— äººè°ƒç”¨ |
| **MonitoringSystem** | ğŸŸ¡ æ¨¡æ‹Ÿæ•°æ® | features off æ—¶è¿”å›å‡è¿æ¥ (firefoxâ†’google, curlâ†’github) |
| **per-connection å­—èŠ‚è®¡æ•°** | ğŸ”´ æœªè¿æ¥ | `RouteConnectionManager` æœ‰ V2Ray TrafficRecorder ä½†ä¸æš´éœ² |
| **Rule/chain å…ƒæ•°æ®** | ğŸ”´ æœªæ•è· | è·¯ç”±å†³ç­–ç»“æœæœªå­˜å‚¨åˆ°è¿æ¥çº§ç»“æ„ |
| **è¿›ç¨‹æ£€æµ‹** | ğŸ”´ æœªæ¥å…¥ | `ProcessMatcher` å­˜åœ¨ä½†æœªåœ¨è¿æ¥å»ºç«‹æ—¶è°ƒç”¨ |

### 3.2 ç°æœ‰ä»£ç èµ„äº§

å·²å­˜åœ¨å¯å¤ç”¨çš„ä»£ç :

1. **`sb-api/managers.rs::ConnectionManager`** â€” HashMap + atomic countersï¼Œç»“æ„è‰¯å¥½
2. **`sb-api/managers.rs::Connection`** â€” per-connection ç»“æ„å« `upload: Arc<AtomicU64>`, `download: Arc<AtomicU64>`
3. **`sb-api/types.rs::Connection`** â€” API è¾“å‡ºç±»å‹ï¼ŒGo-compatible JSON
4. **`sb-common/conntrack.rs::ConnTracker`** â€” DashMap å®ç°ï¼Œå« close_all()
5. **`sb-core/router/conn.rs::RouteConnectionManager`** â€” çœŸå® dial + åŒå‘æ‹·è´
6. **`sb-api/clash/websocket.rs`** â€” å·²æœ‰ traffic/memory WS æ¡†æ¶

### 3.3 handlers.rs å½“å‰ä»£ç åˆ†æ

**`get_connections()`** (è¡Œ 647-676):
- è¯»å– `state.connection_manager`ï¼ˆå§‹ç»ˆ `None`ï¼‰
- è°ƒç”¨ `get_connections()` + `convert_connection()` è½¬æ¢æ ¼å¼
- æ±‚å’Œ `uploadTotal`/`downloadTotal`
- è°ƒç”¨ `get_process_memory_pub()` è·å–å†…å­˜
- æ ¼å¼æ­£ç¡®: `{downloadTotal, uploadTotal, connections, memory}`

**`close_connection()`** (è¡Œ 681-708):
- è°ƒç”¨ `connection_manager.remove_connection(&id)` â€” ä»…åˆ  HashMapï¼Œä¸å…³ socket

**`close_all_connections()`** (è¡Œ 713-725):
- è°ƒç”¨ `connection_manager.close_all_connections()` â€” ä»… `clear()`

**`upgrade_connections()`** (è¡Œ 1816-1828):
- å®Œå…¨ stubï¼Œè¿”å›é™æ€ JSON

---

## å››ã€å®Œæ•´ç¼ºå£æ¸…å•

| # | ç¼ºå£ | ä¸¥é‡åº¦ | è¯´æ˜ |
|---|------|--------|------|
| G1 | **æ— è¿æ¥æ³¨å†Œ** | ğŸ”´ Critical | çœŸå®è¿æ¥ (RouteConnectionManager) ä¸é€šçŸ¥ API å±‚ ConnectionManager |
| G2 | **æ—  per-connection å­—èŠ‚è®¡æ•°** | ğŸ”´ Critical | æ—  counter-wrapped connectionï¼Œupload/download å§‹ç»ˆ 0 |
| G3 | **æ— å…¨å±€æµé‡è®¡æ•°** | ğŸ”´ Critical | `downloadTotal`/`uploadTotal` åº”æ˜¯å…¨å±€ç´¯è®¡åŸå­è®¡æ•° |
| G4 | **æ—  /connections WebSocket** | ğŸ”´ Critical | GUI ä¾èµ– WS æ¨é€å®Œæ•´ snapshot |
| G5 | **æ—  /traffic çœŸå®æ•°æ®** | ğŸ”´ Critical | å½“å‰å‘é€ mock +1000/+4000 |
| G6 | **close ä¸å…³ socket** | ğŸŸ¡ High | DELETE /connections/:id ä»…åˆ  HashMap |
| G7 | **æ—  chain æ„å»º** | ğŸŸ¡ High | è¿æ¥ç¼ºå°‘ outbound chain ä¿¡æ¯ |
| G8 | **æ—  rule æ•è·** | ğŸŸ¡ High | è¿æ¥ç¼ºå°‘åŒ¹é…çš„è·¯ç”±è§„åˆ™ä¿¡æ¯ |
| G9 | **start æ ¼å¼é”™è¯¯** | ğŸŸ¡ High | Unix ms å­—ç¬¦ä¸² â†’ åº”ä¸º ISO 8601/RFC3339 |
| G10 | **æ—  closed connections å†å²** | ğŸŸ¢ Medium | Go ä¿ç•™æœ€è¿‘ 1000 ä¸ªå·²å…³é—­è¿æ¥ |
| G11 | **æ— è¿›ç¨‹æ£€æµ‹** | ğŸŸ¢ Medium | processPath å§‹ç»ˆç©º |
| G12 | **æ—  DNS è¿æ¥è¿‡æ»¤** | ğŸŸ¢ Medium | Go ä» snapshot è¿‡æ»¤ DNS ç±»å‹è¿æ¥ |
| G13 | **metadata éƒ¨åˆ†ç¡¬ç¼–ç ** | ğŸŸ¢ Medium | inbound name/type ç­‰å­—æ®µä¸ºé»˜è®¤å€¼ |

---

## äº”ã€è®¾è®¡å†³ç­–ç‚¹

### 5.1 æ¶æ„é€‰æ‹©ï¼šConnectionTracker trait vs ç›´æ¥æ³¨å…¥

**é€‰é¡¹ A**: Go æ¨¡å¼ â€” å®šä¹‰ `ConnectionTracker` traitï¼ŒRouter æŒæœ‰ `Vec<Arc<dyn ConnectionTracker>>`
- ä¼˜ç‚¹: ä¸ Go æ¶æ„ä¸€è‡´ï¼Œæ”¯æŒå¤šä¸ª tracker (Clash + V2Ray)
- ç¼ºç‚¹: éœ€è¦æ”¹ Routerï¼Œå½±å“é¢å¤§

**é€‰é¡¹ B**: ç›´æ¥æ³¨å…¥ â€” åœ¨ç°æœ‰è¿æ¥å¤„ç†è·¯å¾„ä¸­ç›´æ¥è°ƒç”¨ API `ConnectionManager`
- ä¼˜ç‚¹: æ”¹åŠ¨æœ€å°ï¼Œåˆ©ç”¨ç°æœ‰ `sb-api/managers.rs::ConnectionManager`
- ç¼ºç‚¹: Clash API ç‰¹å®šé€»è¾‘æ¸—å…¥ core å±‚

**é€‰é¡¹ C**: å…±äº« `ConnTracker` (sb-common) â€” ä½œä¸ºä¸­é—´å±‚
- ä¼˜ç‚¹: sb-common å·²æœ‰ `ConnTracker` + `ConnMetadata` + DashMap
- ç¼ºç‚¹: éœ€è¦åŠ æµé‡è®¡æ•°ï¼ŒAPI å±‚éœ€è¦é€‚é…

**æ¨è**: **é€‰é¡¹ A ç®€åŒ–ç‰ˆ** â€” åœ¨ sb-core å®šä¹‰ traitï¼Œä½† L2.8 ä»…å®ç° Clash API trackerï¼ˆä¸åš V2Rayï¼‰ï¼Œé€šè¿‡ Context æ³¨å…¥ã€‚

### 5.2 å­—èŠ‚è®¡æ•°æ–¹æ¡ˆ

**é€‰é¡¹ A**: Counter wrapper (Go æ¨¡å¼) â€” åŒ…è£… `TcpStream` / `AsyncRead+AsyncWrite`
- ä¼˜ç‚¹: ç²¾ç¡®è®¡æ•°ï¼Œä¸ Go å®Œå…¨ä¸€è‡´
- ç¼ºç‚¹: éœ€è¦åœ¨ tokio I/O path åŠ  wrapperï¼Œå½±å“æ€§èƒ½

**é€‰é¡¹ B**: åœ¨åŒå‘æ‹·è´å±‚è®¡æ•° â€” ä¿®æ”¹ `RouteConnectionManager::copy_with_recording()`
- ä¼˜ç‚¹: æ”¹åŠ¨é›†ä¸­ï¼Œæ€§èƒ½å½±å“å°
- ç¼ºç‚¹: åªèƒ½åœ¨æ‹·è´å±‚è®¡æ•°ï¼Œä¸å« TLS å¼€é”€

**æ¨è**: **é€‰é¡¹ B** â€” åœ¨å·²æœ‰çš„ `copy_with_recording()` / `new_connection()` ä¸­åŠ å…¥åŸå­è®¡æ•°å³å¯ã€‚

### 5.3 Close ä¿¡å·ä¼ æ’­

**é€‰é¡¹ A**: `CancellationToken` per connection
- ä¼˜ç‚¹: tokio åŸç”Ÿï¼Œclean cancellation
- ç¼ºç‚¹: éœ€è¦åœ¨æ¯ä¸ªè¿æ¥åˆ›å»ºæ—¶ä¼ å…¥ token

**é€‰é¡¹ B**: ç›´æ¥ `abort()` JoinHandle
- ä¼˜ç‚¹: ç®€å•
- ç¼ºç‚¹: ä¸ä¼˜é›…ï¼Œå¯èƒ½æ³„éœ²èµ„æº

**é€‰é¡¹ C**: åœ¨ ConnectionManager ä¸­å­˜å‚¨ `oneshot::Sender<()>`
- ä¼˜ç‚¹: ä¸ç°æœ‰æ¶æ„ä¸€è‡´
- ç¼ºç‚¹: åªèƒ½å…³é—­ä¸€æ¬¡

**æ¨è**: **é€‰é¡¹ A** â€” æ¯ä¸ªè¿æ¥æŒæœ‰ `CancellationToken`ï¼Œclose æ—¶ cancelã€‚

### 5.4 å“ªäº›ç°æœ‰ä»£ç å¯ä»¥å¤ç”¨

| ä»£ç  | å¤ç”¨æ–¹å¼ |
|------|---------|
| `sb-api/managers.rs::Connection` | ä¿®æ”¹: åŠ  `CancellationToken`, ä¿ç•™ `Arc<AtomicU64>` counters |
| `sb-api/managers.rs::ConnectionManager` | ä¿®æ”¹: åŠ å…¨å±€ atomic counters, closed list |
| `sb-api/types.rs::Connection` | ä¿æŒ: API è¾“å‡ºç±»å‹å·²æ­£ç¡® |
| `sb-api/clash/websocket.rs` | æ‰©å±•: åŠ  connections WS handler |
| `sb-core/router/conn.rs` | ä¿®æ”¹: æ³¨å†Œè¿æ¥ + å­—èŠ‚è®¡æ•° |

### 5.5 ä¸åšä»€ä¹ˆï¼ˆå»¶ååˆ° L2.8+ï¼‰

- conntrack OOM kill switch (L1 çº§ï¼Œå¯é€‰)
- V2Ray StatsService per-inbound/per-outbound ç»Ÿè®¡
- è¿›ç¨‹æ£€æµ‹ (ProcessMatcher æ¥å…¥)
- closed connections å†å²åˆ—è¡¨ (1000 ä¸Šé™)
- DNS è¿æ¥è¿‡æ»¤
- idle timeout / freshness skip

---

## å…­ã€é¢„ä¼°å­ä»»åŠ¡åˆ†è§£

| æ­¥éª¤ | å­ä»»åŠ¡ | æ–‡ä»¶æ•° | ä¾èµ– |
|------|--------|--------|------|
| L2.8.1 | ConnectionTracker trait + Manager å¢å¼º | 3-4 | æ—  |
| L2.8.2 | Counter wrapper / å­—èŠ‚è®¡æ•° | 2-3 | L2.8.1 |
| L2.8.3 | è¿æ¥æ³¨å†Œ + å…ƒæ•°æ®æ•è· (chain/rule) | 3-4 | L2.8.1 |
| L2.8.4 | Close ä¿¡å·ä¼ æ’­ (CancellationToken) | 2-3 | L2.8.3 |
| L2.8.5 | /connections WebSocket handler | 1-2 | L2.8.1 |
| L2.8.6 | /traffic WebSocket çœŸå®æ•°æ® | 1-2 | L2.8.2 |
| L2.8.7 | handlers.rs æ¥çº¿ + start æ ¼å¼ä¿®å¤ | 1-2 | L2.8.3 |

**å·¥ä½œé‡è¯„ä¼°**: ä¸­åå¤§ã€‚æ ¸å¿ƒéš¾ç‚¹åœ¨ L2.8.2ï¼ˆå­—èŠ‚è®¡æ•°éœ€è¦ä¸ I/O path é›†æˆï¼‰å’Œ L2.8.3ï¼ˆå…ƒæ•°æ®éœ€è¦ä» Router å±‚ä¼ é€’åˆ° API å±‚ï¼‰ã€‚

---

## ä¸ƒã€Go å…³é”®æºæ–‡ä»¶é€ŸæŸ¥

| æ–‡ä»¶ | å…³é”®å†…å®¹ |
|------|---------|
| `adapter/router.go:31-34` | `ConnectionTracker` interface |
| `adapter/connections.go:10-14` | `ConnectionManager` interface |
| `trafficontrol/tracker.go:18-29` | `TrackerMetadata` struct |
| `trafficontrol/tracker.go:89-254` | `TCPConn`/`UDPConn` + counter wrapping |
| `trafficontrol/tracker.go:129-147` | Chain building logic |
| `trafficontrol/manager.go:18-130` | `Manager` struct + `Snapshot` |
| `clashapi/connections.go:28-101` | HTTP/WS handlers + close |
| `clashapi/server.go:308-353` | `/traffic` WebSocket (delta) |
| `box.go:351,361` | `router.AppendTracker(clashServer)` wiring |

---

*æœ€åæ›´æ–°ï¼š2026-02-08*
