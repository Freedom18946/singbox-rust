# L2.7 URLTest å†å² + å¥åº·æ£€æŸ¥å¯¹é½ â€” ç¼ºå£åˆ†æ

> **ç”¨é€”**: L2.7 å®æ–½å‰ç½®åˆ†æï¼ŒGo vs Rust å®Œæ•´å¯¹æ¯”
> **ç”Ÿæˆæ—¥æœŸ**: 2026-02-08
> **å®æ–½çŠ¶æ€**: âœ… **å·²å®Œæˆ** (2026-02-08)
> **ç›¸å…³ Go æºç **: `go_fork_source/sing-box-1.12.14/`
> **Parity é¢„ä¼°**: 91% â†’ 92%
>
> **å·²å®æ–½è¦†ç›–**: G1 âœ… G2 âœ… G3 âœ… G4 âœ… G6 âœ… G14 âœ… | å»¶å: G5 G7-G13

---

## ä¸€ã€Go å‚è€ƒå®ç°æ¦‚è¦

### 1.1 æ ¸å¿ƒæ¶æ„

Go çš„ URLTest æ¶‰åŠ 3 ä¸ªç»„ä»¶ï¼š

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `URLTestGroup` | `protocol/group/urltest.go` | é€‰æ‹©é€»è¾‘ + å¥åº·æ£€æŸ¥å¾ªç¯ |
| `URLTestHistoryStorage` | `adapter/experimental.go` + `common/urltest/urltest.go` | å…¨å±€å…±äº«å»¶è¿Ÿå†å²å­˜å‚¨ |
| `Clash API handlers` | `experimental/clashapi/proxies.go` + `api_meta_group.go` | æš´éœ²å†å²åˆ° API |

### 1.2 URLTestHistoryStorage

```go
// adapter/experimental.go
type URLTestHistory struct {
    Time  time.Time `json:"time"`
    Delay uint16    `json:"delay"`
}

type URLTestHistoryStorage interface {
    SetHook(hook chan<- struct{})
    LoadURLTestHistory(tag string) *URLTestHistory
    DeleteURLTestHistory(tag string)
    StoreURLTestHistory(tag string, history *URLTestHistory)
    Close() error
}
```

**å…³é”®ç‰¹å¾**:
- **æ¯ tag ä»… 1 æ¡è®°å½•** â€” `map[string]*URLTestHistory`ï¼Œä¸æ˜¯æ•°ç»„
- **å…¨å±€å…±äº«** â€” URLTest ç»„å’Œ Clash API server å¼•ç”¨åŒä¸€å®ä¾‹
- **æ¥æºä¼˜å…ˆçº§**: context > ClashServer.HistoryStorage() > new instance
- **çº¿ç¨‹å®‰å…¨** â€” RWMutex ä¿æŠ¤

### 1.3 URL æµ‹è¯•æ–¹æ³•

```go
// common/urltest/urltest.go â€” URLTest()
func URLTest(ctx context.Context, link string, detour N.Dialer) (t uint16, err error) {
    // 1. è§£æ URL, æå– host:port
    // 2. é€šè¿‡ outbound å»ºç«‹ TCP è¿æ¥ (detour.DialContext)
    // 3. åˆ›å»º http.Clientï¼ŒTransport.DialContext å¤ç”¨å·²å»ºè¿æ¥
    // 4. å‘é€ HTTP HEAD è¯·æ±‚ (ä¸æ˜¯ GET)
    // 5. TLS æ”¯æŒ (http.Client è‡ªåŠ¨å¤„ç†)
    // 6. ä¸è·Ÿéšé‡å®šå‘ (http.ErrUseLastResponse)
    // 7. è¿”å› uint16 å»¶è¿Ÿæ¯«ç§’æ•°
}
```

| å‚æ•° | Go é»˜è®¤å€¼ |
|------|----------|
| URL | `https://www.gstatic.com/generate_204` |
| Timeout | 15 ç§’ (`C.TCPTimeout`) |
| Method | HTTP HEAD |
| Concurrency | 10 goroutine (batch) |
| http:// URL | **æ‹’ç»**ï¼Œæ›¿æ¢ä¸ºé»˜è®¤ HTTPS URL |

### 1.4 Tolerance / Sticky é€‰æ‹©é€»è¾‘

```go
// Select() â€” æ¯æ¬¡è¿æ¥æ—¶è°ƒç”¨
func (g *URLTestGroup) Select(network string) (adapter.Outbound, bool) {
    var minDelay uint16
    var minOutbound adapter.Outbound

    // 1. ä»å½“å‰å·²é€‰çš„ outbound å¼€å§‹ (sticky)
    if g.selectedOutboundTCP != nil {
        if history := g.history.LoadURLTestHistory(RealTag(g.selectedOutboundTCP)); history != nil {
            minOutbound = g.selectedOutboundTCP
            minDelay = history.Delay
        }
    }

    // 2. ä»…å½“æ–°å€™é€‰è€…çš„å»¶è¿Ÿæ¯”å½“å‰ä½ tolerance ä»¥ä¸Šæ—¶æ‰åˆ‡æ¢
    for _, detour := range g.outbounds {
        history := g.history.LoadURLTestHistory(RealTag(detour))
        if history == nil { continue }
        if minDelay == 0 || minDelay > history.Delay + g.tolerance {
            minDelay = history.Delay
            minOutbound = detour
        }
    }

    // 3. æ— å†å²æ•°æ®æ—¶å…œåº•åˆ°ç¬¬ä¸€ä¸ªæ”¯æŒè¯¥ç½‘ç»œçš„
    if minOutbound == nil { ... fallback ... }
    return minOutbound, true
}
```

**å…³é”®**: `minDelay > history.Delay + g.tolerance` â€” æ–°å€™é€‰è€…å¿…é¡»æ¯”å½“å‰æœ€ä¼˜ä½ tolerance ms æ‰ä¼šåˆ‡æ¢ï¼Œé˜²æ­¢æŠ–åŠ¨ã€‚

### 1.5 å¥åº·æ£€æŸ¥è§¦å‘æœºåˆ¶

| è§¦å‘æ–¹å¼ | è¯´æ˜ |
|----------|------|
| PostStart | å¯åŠ¨åç«‹å³è§¦å‘ä¸€æ¬¡ `CheckOutbounds(false)` |
| Touch() | æ¯æ¬¡ DialContext/ListenPacket æ—¶è°ƒç”¨ï¼Œåˆ›å»º ticker + æ›´æ–° lastActive |
| loopCheck | ticker å‘¨æœŸï¼ˆintervalï¼‰æ£€æŸ¥: è¶…è¿‡ idleTimeout åˆ™åœæ­¢; å¦åˆ™ CheckOutbounds |
| Force | Clash API `urlTestGroup.URLTest(ctx)` å¼ºåˆ¶æµ‹è¯• |

**è·³è¿‡é€»è¾‘**: `!force && history != nil && time.Since(history.Time) < interval` â†’ è·³è¿‡è¿‘æœŸå·²æµ‹è¯•çš„

### 1.6 å¤±è´¥å¤„ç†

- **URL test å¤±è´¥**: `DeleteURLTestHistory(tag)` â€” åˆ é™¤å†å²ï¼ˆä¸æ˜¯æ ‡è®°ä¸å¥åº·ï¼‰
- **DialContext å¤±è´¥**: åŒæ · `DeleteURLTestHistory(tag)`
- **æˆåŠŸæ¢å¤**: ä¸‹æ¬¡ URL test æˆåŠŸæ—¶é‡æ–° `StoreURLTestHistory(tag, {...})`
- **é€‰æ‹©æ›´æ–°å**: ä¸­æ–­ç°æœ‰è¿æ¥ (`interruptGroup.Interrupt()`)

### 1.7 proxyInfo() æš´éœ²

```go
func proxyInfo(server *Server, detour adapter.Outbound) *badjson.JSONObject {
    // history æŸ¥æ‰¾ä½¿ç”¨ OutboundTag(detour)
    //   - æ™®é€š proxy: detour.Tag()
    //   - group: group.Now() (å½“å‰é€‰ä¸­æˆå‘˜)
    delayHistory := server.urlTestHistory.LoadURLTestHistory(adapter.OutboundTag(detour))
    if delayHistory != nil {
        info.Put("history", []*adapter.URLTestHistory{delayHistory})
    } else {
        info.Put("history", []*adapter.URLTestHistory{})
    }
    // æ³¨æ„: Go ä¸è®¾ alive/delay é¡¶çº§å­—æ®µ
    // GUI ä» history[last].delay æ¨å¯¼
}
```

---

## äºŒã€Rust å½“å‰å®ç°çŠ¶æ€

### 2.1 SelectorGroup å¥åº·æ£€æŸ¥

| æ–¹é¢ | å½“å‰çŠ¶æ€ |
|------|----------|
| `start_health_check()` | ä»… UrlTest æ¨¡å¼å¯åŠ¨ï¼Œweak ref è‡ªåŠ¨åœæ­¢ |
| å¾ªç¯æ–¹å¼ | å›ºå®š interval sleepï¼ˆæ—  idle timeoutï¼‰ |
| `run_health_checks()` | å¯¹æ¯ä¸ªæˆå‘˜ spawn ç‹¬ç«‹ taskï¼ˆæ— å¹¶å‘é™åˆ¶ï¼‰ |
| `health_check_via()` | HTTPS: ä»… TCP connect; HTTP: å‘é€ HEAD + è¯»å“åº” |
| é»˜è®¤ test URL | `http://cp.cloudflare.com`ï¼ˆä¸ Go ä¸åŒï¼‰ |
| é»˜è®¤ interval | 10 minï¼ˆGo: 3 minï¼‰ |
| é»˜è®¤ timeout | 5 secï¼ˆGo: 15 secï¼‰ |

### 2.2 ProxyHealth

```rust
pub struct ProxyHealth {
    is_alive: Arc<parking_lot::RwLock<bool>>,
    last_rtt_ms: AtomicU64,
    consecutive_fails: AtomicUsize,
    last_check: Mutex<Option<Instant>>,       // å•è°ƒæ—¶é’Ÿï¼Œä¸å¯åºåˆ—åŒ–
    active_connections: AtomicUsize,
    permanent_failure: AtomicBool,
    last_error: Mutex<Option<String>>,
}
```

**ç¼ºå¤±**:
- æ—  `SystemTime` æ—¶é—´æˆ³ï¼ˆæ— æ³•ç”Ÿæˆ ISO 8601 ç»™ APIï¼‰
- æ— å…±äº«çš„å†å²å­˜å‚¨ï¼ˆ`ProxyHealth` æ˜¯ `SelectorGroup` å†…éƒ¨ per-member ç»“æ„ï¼‰
- `record_failure()` é€’å¢ `consecutive_fails`ï¼ˆGo æ˜¯åˆ é™¤å†å²è®°å½•ï¼‰

### 2.3 select_by_latency()

```rust
fn select_by_latency(&self) -> Option<&ProxyMember> {
    let healthy = self.members.iter().filter(|m| m.health.is_healthy());
    let best = healthy.iter().min_by_key(|m| m.health.get_rtt_ms()).copied();
    let _ = self.tolerance_ms; // æ ‡è®°ä¸ºæ•…æ„æœªä½¿ç”¨
    best
}
```

**`tolerance_ms` å®Œå…¨æœªä½¿ç”¨**ã€‚æ€»æ˜¯é€‰ç»å¯¹æœ€ä½å»¶è¿Ÿï¼Œæ—  sticky é˜²æŠ–ã€‚

### 2.4 Clash API çŠ¶æ€

`ApiState` ä¸­**æ— ä»»ä½•å†å²å­˜å‚¨å­—æ®µ**ã€‚

### 2.5 API handlers

| handler | å½“å‰è¡Œä¸º | Go è¡Œä¸ºå·®å¼‚ |
|---------|----------|------------|
| `get_proxies` / `get_proxy` | `history: vec![]`, `alive: Some(true)` | Go ä» `urlTestHistory` å¡«å…… history |
| `get_proxy_delay` | è¿”å› `{"delay":N}` ä½†ä¸å­˜å‚¨ | Go å­˜å‚¨åˆ° `urlTestHistory` |
| `get_meta_group_delay` | è¿”å› `{tag:delay}` ä½†ä¸å­˜å‚¨ | Go å­˜å‚¨åˆ° `urlTestHistory` |

### 2.6 GUI æœŸæœ›

```typescript
// kernel.d.ts
export interface CoreApiProxy {
  alive: boolean
  history: { delay: number }[]
  // ...
}

// GroupsController.vue â€” æ´»æ€§åˆ¤æ–­
const history = proxies[proxy]?.history || []
const alive = (history[history.length - 1]?.delay ?? 0) > 0

// GUI åœ¨æµ‹å»¶è¿Ÿåæœ¬åœ° push
_proxy && _proxy.history.push({ delay })
```

GUI ä¸¤ä¸ªå…³é”®è¡Œä¸º:
1. ä» `history[last].delay` æ¨å¯¼ alive çŠ¶æ€
2. æµ‹å»¶è¿Ÿååœ¨å®¢æˆ·ç«¯æœ¬åœ° push historyï¼ˆä½†åˆ·æ–° proxies æ—¶ä» server é‡æ–°æ‹¿ï¼‰

---

## ä¸‰ã€å®Œæ•´ç¼ºå£æ¸…å•

| # | ç¼ºå£ | ä¸¥é‡åº¦ | è¯´æ˜ |
|---|------|--------|------|
| G1 | **æ—  URLTestHistoryStorage** | ğŸ”´ Critical | æ— å…¨å±€å…±äº«å»¶è¿Ÿå†å²ã€‚Go æœ‰ `HistoryStorage` map keyed by tag |
| G2 | **history å§‹ç»ˆç©º** | ğŸ”´ Critical | API è¿”å› `history: []`ï¼ŒGUI æ— æ³•æ˜¾ç¤ºå»¶è¿Ÿ/åˆ¤æ–­æ´»æ€§ |
| G3 | **delay ç»“æœä¸å­˜å‚¨** | ğŸ”´ Critical | `get_proxy_delay` / `get_meta_group_delay` ä¸¢å¼ƒç»“æœ |
| G4 | **tolerance_ms æœªä½¿ç”¨** | ğŸŸ¡ High | æ—  sticky switching é˜²æŠ–ï¼Œä¼šå¯¼è‡´é¢‘ç¹åˆ‡æ¢ |
| G5 | **HTTPS å¥åº·æ£€æŸ¥ä¸å®Œæ•´** | ğŸŸ¡ High | HTTPS URL ä»… TCP connectï¼Œä¸åš TLS/HTTP |
| G6 | **alive/delay æœªä»å¥åº·æ•°æ®å¡«å……** | ğŸŸ¡ High | handlers ä¸è¯» ProxyHealth / members_health() |
| G7 | **æ—  idle timeout** | ğŸŸ¢ Medium | å¾ªç¯æ°¸ä¸åœæ­¢ï¼ˆGo æœ‰ idle 30min è‡ªåŠ¨åœæ­¢ï¼‰ |
| G8 | **æ—  TCP/UDP åˆ†ç¦»é€‰æ‹©** | ğŸŸ¢ Medium | Go åˆ† selectedOutboundTCP / selectedOutboundUDP |
| G9 | **æ— å¹¶å‘é™åˆ¶** | ğŸŸ¢ Medium | Go é™åˆ¶ 10 goroutine, Rust æ— é™ spawn |
| G10 | **æ—  freshness skip** | ğŸŸ¢ Medium | Go è·³è¿‡ interval å†…å·²æµ‹è¯•çš„æˆå‘˜ |
| G11 | **æ— è¿æ¥ä¸­æ–­** | ğŸ”µ Low | Go é€‰æ‹©å˜æ›´åä¸­æ–­ç°æœ‰è¿æ¥ |
| G12 | **æ—  updateHook é€šçŸ¥** | ğŸ”µ Low | Go HistoryStorage æœ‰ hook channel |
| G13 | **http:// URL ä¸æ‹’ç»** | ğŸ”µ Low | Go æ‹’ç» http:// æµ‹è¯• URLï¼ˆå®‰å…¨è€ƒè™‘ï¼‰ |
| G14 | **é»˜è®¤å€¼ä¸ä¸€è‡´** | ğŸŸ¢ Medium | URL/interval/timeout ä¸ Go ä¸åŒ |

---

## å››ã€å»ºè®®å®æ–½èŒƒå›´ï¼ˆL2.7 æ ¸å¿ƒ vs å»¶åï¼‰

### L2.7 æ ¸å¿ƒï¼ˆå¿…åšï¼ŒGUI å¯æ„ŸçŸ¥ï¼‰

| å­ä»»åŠ¡ | è¦†ç›–ç¼ºå£ | è¯´æ˜ |
|--------|----------|------|
| **L2.7.1** URLTestHistoryStorage å®ç° | G1 | å…¨å±€ `Arc<RwLock<HashMap<String, URLTestHistory>>>` |
| **L2.7.2** å¥åº·æ£€æŸ¥å†™å…¥ HistoryStorage | G1, G3 | health_check ç»“æœå­˜å…¥å…±äº«å­˜å‚¨ |
| **L2.7.3** API delay ç«¯ç‚¹å†™å…¥ HistoryStorage | G3 | get_proxy_delay / get_meta_group_delay å­˜å‚¨ç»“æœ |
| **L2.7.4** proxyInfo å¡«å…… history | G2, G6 | get_proxies/get_proxy ä» HistoryStorage è¯»å–å¹¶å¡«å…… |
| **L2.7.5** tolerance å®ç° | G4 | select_by_latency åŠ  tolerance é˜²æŠ–é€»è¾‘ |
| **L2.7.6** é»˜è®¤å€¼å¯¹é½ | G14 | URL â†’ https://..., interval â†’ 3min |

### å»¶åï¼ˆL2.8+ æˆ–ä¸åšï¼‰

| å­ä»»åŠ¡ | è¦†ç›–ç¼ºå£ | ç†ç”± |
|--------|----------|------|
| HTTPS å¥åº·æ£€æŸ¥å®Œå–„ | G5 | éœ€è¦ TLS å®¢æˆ·ç«¯é›†æˆï¼Œå¤æ‚åº¦é«˜ |
| idle timeout | G7 | èµ„æºä¼˜åŒ–ï¼Œä¸å½±å“ GUI |
| TCP/UDP åˆ†ç¦»é€‰æ‹© | G8 | å¤æ‚åº¦é«˜ï¼Œå•ä¸€é€‰æ‹©å·²å¤Ÿç”¨ |
| å¹¶å‘é™åˆ¶ | G9 | æˆå‘˜æ•°é€šå¸¸ä¸å¤š |
| freshness skip | G10 | ä¼˜åŒ–é¡¹ |
| è¿æ¥ä¸­æ–­ | G11 | L2.8 ConnectionTracker èŒƒå›´ |
| updateHook | G12 | å¯é€‰ä¼˜åŒ– |
| http:// æ‹’ç» | G13 | å®‰å…¨åŠ å›º |

---

## äº”ã€å…³é”®è®¾è®¡å†³ç­–ç‚¹

### 5.1 HistoryStorage æ”¾åœ¨å“ªä¸ª crate?

**é€‰é¡¹ A**: `sb-core` â€” ä¸ SelectorGroup åŒçº§
- ä¼˜ç‚¹: SelectorGroup å¯ç›´æ¥å¼•ç”¨
- ç¼ºç‚¹: sb-api ä¹Ÿéœ€è¦å¼•ç”¨ï¼Œå¢åŠ è€¦åˆ

**é€‰é¡¹ B**: `sb-types` â€” ä½œä¸º port trait
- ä¼˜ç‚¹: å¥‘çº¦å±‚ï¼Œsb-core å’Œ sb-api éƒ½å¯å¼•ç”¨
- ç¼ºç‚¹: sb-types ä¸åº”æœ‰è¿è¡Œæ—¶é€»è¾‘

**é€‰é¡¹ C**: `sb-core` å®šä¹‰ traitï¼Œ`sb-core` å®ç°ï¼Œé€šè¿‡ ContextRegistry ä¼ é€’ï¼ˆä¸ CacheFile æ¨¡å¼ä¸€è‡´ï¼‰
- ä¼˜ç‚¹: å·²æœ‰å…ˆä¾‹æ¨¡å¼
- æ¨è: âœ…

### 5.2 ProxyHealth æ˜¯å¦éœ€è¦æ”¹åŠ¨?

**å»ºè®®**: ä¿æŒ `ProxyHealth` ä¸å˜ã€‚æ–°å¢ç‹¬ç«‹çš„ `URLTestHistoryStorage` ä½œä¸ºå…¨å±€å­˜å‚¨ã€‚
ç†ç”±: ProxyHealth æ˜¯ per-member å†…éƒ¨çŠ¶æ€ï¼ŒHistoryStorage æ˜¯å…¨å±€å…±äº« API å±‚çŠ¶æ€ï¼ŒèŒè´£ä¸åŒã€‚

### 5.3 history æ•°ç»„é•¿åº¦

Go åªå­˜ 1 æ¡è®°å½•ï¼ŒAPI è¿”å› `[{time, delay}]` æˆ– `[]`ã€‚GUI åªè¯» `history[last]`ã€‚
**å»ºè®®**: ä¸ Go å¯¹é½ï¼Œæ¯ tag ä»… 1 æ¡ã€‚

### 5.4 OutboundTag é€»è¾‘

Go: `OutboundTag(group) = group.Now()` â€” group çš„ history æŸ¥æ‰¾é”®æ˜¯å½“å‰é€‰ä¸­æˆå‘˜çš„ tagã€‚
è¿™æ„å‘³ç€ URLTest group æ˜¾ç¤ºçš„æ˜¯å…¶æœ€ä½³æˆå‘˜çš„å»¶è¿Ÿã€‚
**å»ºè®®**: ä½¿ç”¨ `OutboundGroup::now()` ä½œä¸º lookup keyï¼ˆL2.6 å·²æœ‰ `as_group().now()`ï¼‰ã€‚

---

*æœ€åæ›´æ–°ï¼š2026-02-08*
