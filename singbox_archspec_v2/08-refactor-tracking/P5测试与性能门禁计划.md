# P5 测试与性能门禁 - 实施计划

## 目标

对照 `testing-strategy.md` 和 `performance-guidelines.md`，建立可执行的测试门禁与性能回归保护。

---

## 一、测试金字塔审计结果 ✅

### 测试数量统计

| Crate | 测试数 | 符合要求 |
|-------|--------|----------|
| sb-types | 5 | ✅ 编译期契约测试 |
| sb-core | 707 | ✅ 大量逻辑单元测试 |
| sb-adapters | 80 | ✅ 协议 integration tests |
| sb-platform | 56 | ✅ 平台适配测试 |
| sb-config | 116 | ✅ 配置解析测试 |

**结论**: 测试金字塔各层级覆盖良好（共 964+ 测试）。

---

## 二、性能指标实现状态 ✅

### 已实现指标（Counter）

| 指标 | 位置 |
|------|------|
| `sb_outbound_connect_total` | telemetry.rs ✅ |
| `sb_outbound_handshake_total` | telemetry.rs ✅ |
| `sb_inbound_parse_total` | telemetry.rs ✅ |
| `sb_inbound_forward_total` | telemetry.rs ✅ |
| `sb_router_select_total` | telemetry.rs ✅ |

### 已添加 Histogram 指标

| 指标 | 函数 |
|------|------|
| `sb_outbound_connect_seconds` | `outbound_connect_latency()` |
| `sb_dns_resolve_seconds` | `dns_resolve_latency()` |
| `sb_route_decision_seconds` | `route_decision_latency()` |
| `sb_relay_bytes_total` | `relay_bytes()` |

---

## 三、CI 门禁配置 ✅

`.github/workflows/ci.yml` 包含以下任务：

| Job | 描述 | 状态 |
|-----|------|------|
| build | 默认构建 + 测试 | ✅ |
| parity | Go 兼容特性构建 | ✅ |
| clippy | 代码检查 (`-D warnings`) | ✅ |
| fmt | 格式检查 | ✅ |
| cross-platform | 跨平台 (Linux/macOS/Windows) | ✅ |
| smoke-test | 烟雾测试 | ✅ |

---

## 四、实施步骤

### Phase A: ✅ 测试覆盖审计完成
### Phase B: ✅ Histogram 指标添加完成
### Phase C: ✅ CI 门禁验证完成

---

## 验收标准

- [x] 测试金字塔各层级有明确执行清单
- [x] 4 个关键 histogram 指标已实现
- [x] 热路径代码通过 clippy 检查
- [x] CI 门禁配置确认
