# P4 模块归属迁移计划

## 背景

按照 `singbox_archspec_v2` 规范，协议实现应在 `sb-adapters`，`sb-core` 应只包含路由、策略和会话编排逻辑。

## 当前状态

| 位置 | 协议实现 | 使用的 Trait |
|------|----------|--------------|
| sb-core/outbound/ | trojan, vmess, vless, shadowsocks, hysteria2, tuic, ssh, wireguard | `OutboundConnectorIo` (sb-core trait) |
| sb-adapters/outbound/ | 同上 + http, socks4/5, dns, tor, anytls | `OutboundConnector` (sb-adapters trait) |

**问题**：两套实现共存，职责边界混乱。

## 迁移策略

> [!WARNING]
> P4 是风险最高的阶段。建议分步渐进，每步验证后再继续。

### 阶段 A：确认 sb-adapters 为主版本（低风险）

1. 确认 sb-adapters 实现功能完整
2. 如缺失功能，从 sb-core 迁移代码补全
3. 验证 sb-adapters 的适配器能通过测试

### 阶段 B：sb-core 废弃旧实现（中风险）

1. 在 sb-core 添加 `#[deprecated]` 注解
2. 修改调用点使用 sb-adapters 实现
3. 通过集成测试验证功能等价

### 阶段 C：移除废弃代码（高风险）

1. 删除 sb-core 中的协议实现文件
2. 清理 sb-core 的 Cargo.toml 依赖
3. 全量测试通过后合并

## 待迁移协议列表

| 协议 | sb-core 文件 | sb-adapters 文件 | 状态 |
|------|--------------|------------------|------|
| Trojan | `trojan.rs` | `trojan.rs` | 需合并 |
| VMess | `vmess.rs` | `vmess.rs` | 需合并 |
| VLESS | `vless.rs` | `vless.rs` | 需合并 |
| Shadowsocks | `shadowsocks.rs` | `shadowsocks.rs` | 需合并 |
| Hysteria2 | `hysteria2.rs` | `hysteria2.rs` | 需合并 |
| TUIC | `tuic.rs` | `tuic.rs` | 需合并 |
| SSH | `ssh.rs` | `ssh.rs` | 需合并 |
| WireGuard | `wireguard.rs` | `wireguard.rs` | 需合并 |

## 保留在 sb-core

| 模块 | 原因 |
|------|------|
| `direct_connector.rs` | 核心路由基础设施 |
| `manager.rs` | 出站管理器 |
| `selector*.rs` | 负载均衡策略 |
| `health.rs` | 健康检查 |
| `traits.rs` | 核心 Ports 定义（后续迁移到 sb-types） |

## 验证计划

1. `cargo test -p sb-adapters` 每个协议
2. `cargo check -p sb-core` 确保无编译错误
3. 集成测试覆盖关键流程

---

## 阶段 A 验证结果 ✅

| 协议 | 测试命令 | 结果 |
|------|----------|------|
| Trojan | `--features adapter-trojan` | 14 passed |
| VLESS | `--features adapter-vless` | 17 passed |
| VMess | `--features adapter-vmess` | 11 passed |
| 其他 | 默认 features | 编译通过 |

**结论**：sb-adapters 实现功能完整，可作为主版本。

---

## 下一步

> [!IMPORTANT]
> 阶段 A 完成。可以开始阶段 B：在 sb-core 废弃旧实现。

---

## 阶段 B 完成记录 ✅

已废弃的类型（添加 `#[deprecated(since = "0.2.0")]`）：

| 文件 | 类型 |
|------|------|
| `trojan.rs` | `TrojanConfig`, `TrojanOutbound` |
| `vmess.rs` | `VmessConfig`, `VmessOutbound` |
| `vless.rs` | `VlessConfig`, `VlessOutbound` |
| `shadowsocks.rs` | `ShadowsocksConfig`, `ShadowsocksOutbound` |

**编译验证**：`cargo check -p sb-core` ✅

---

## 下一步：阶段 C

> [!WARNING]
> 阶段 C（移除废弃代码）建议等待 1-2 个版本周期后执行，给用户迁移时间。

---

## 阶段 C 完成记录 ✅

**方案选择**：条件编译（选项 2）

**实现**：
1. 添加 `legacy_protocols` feature 到 `sb-core/Cargo.toml`
2. 修改 `mod.rs` 为废弃模块添加 `#[cfg(all(feature = "...", feature = "legacy_protocols"))]`

**影响范围**：
- 模块声明：`shadowsocks`, `trojan`, `vless`, `vmess`
- `OutboundImpl` 枚举：`Trojan`, `Shadowsocks`, `Vless`, `Vmess` 变体

**用法**：
- 默认：`legacy_protocols` 启用→使用旧实现
- 禁用 feature：`--no-default-features` 或显式排除→仅使用 sb-adapters

**验证**：`cargo check -p sb-core --features legacy_protocols` ✅
