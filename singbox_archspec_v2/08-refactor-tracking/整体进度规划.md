# 整体进度规划（主控文档）

> **强制要求**：开始任何操作前必须先读取本文件；结束任何操作后必须更新本文件与 `log.md`。
> - 本文件是唯一“当前进度”来源。
> - 所有阶段状态以本文件为准。

## 总目标

- 按 `singbox_archspec_v2` 的 V2 架构规范，完成重构标准化流程落地与后续改造执行。
- 依赖边界、端口（Ports）契约、异步模型与错误模型必须被持续执行。

## 当前阶段与状态

- 当前阶段：P2-依赖与构建门禁
- 状态：进行中
- 最近更新：2026-02-03
- 门禁策略：临时采用增量测试；合并前需补全全量门禁

## 执行顺序约束

1. 必须按 P0 → P5 顺序推进，上一阶段未验收不得进入下一阶段。
2. 每个阶段开始前更新本文件并记录日志。
3. 每个阶段完成后更新本文件与 `log.md`，并形成阶段产出物。

## 阶段规划与验收标准（含详细任务）

### P0-准备（已完成）

目标：建立流程、日志与进度跟踪机制。
验收：进度规划、日志、操作规程与 `.agent.md` 已落地。
详细任务：
1. 创建 `singbox_archspec_v2/08-refactor-tracking/` 目录。
2. 建立 `log.md`、`整体进度规划.md`、`操作规程.md`、`检查清单.md`。
3. 在根目录建立 `.agent.md` 并写入强制流程。
产出：
1. `singbox_archspec_v2/08-refactor-tracking/log.md`
2. `singbox_archspec_v2/08-refactor-tracking/整体进度规划.md`
3. `singbox_archspec_v2/08-refactor-tracking/操作规程.md`
4. `singbox_archspec_v2/08-refactor-tracking/检查清单.md`
5. `.agent.md`

### P1-边界审计（已完成）

目标：对照 `01-constitution/` 与 `05-reference/dependency-matrix.md` 做依赖边界与职责核查。
验收：形成完整“边界审计报告”，并标注违规或潜在违规点。
详细任务：
1. 读取 `01-constitution/dependency-constitution.md` 与 `05-reference/dependency-matrix.md`。
2. 生成 workspace crate 列表（基于 `Cargo.toml`）。
3. 生成每个 crate 的 direct dependencies 清单（解析各 crate `Cargo.toml`）。
4. 生成 transitive dependency 清单（使用 `cargo metadata --format-version 1` 解析）。
5. 对照允许依赖方向，标注违规、疑似违规与需确认项。
6. 检查 sb-core、sb-types、sb-api 的禁用依赖是否存在。
7. 检查 feature 引入是否存在“依赖方向偷渡”。
8. 形成整改建议与影响范围评估。
9. 更新本文件与 `log.md`。
产出：
1. `singbox_archspec_v2/08-refactor-tracking/边界审计.md`
2. `singbox_archspec_v2/08-refactor-tracking/依赖清单.md`

### P2-依赖与构建门禁（当前）

目标：落实 `01-constitution/ci-enforcement.md` 的依赖边界检查与质量门禁。
验收：依赖边界检查工具就位，CI/本地检查路径明确可执行。
详细任务：
1. 创建依赖边界检查工具或脚本（参考 `01-constitution/ci-enforcement.md`）。
2. 明确依赖白名单来源与维护位置。
3. 输出违反规则时的可读报告格式。
4. 将检查加入 CI 或本地必跑流程。
5. 校验 `cargo fmt`、`cargo clippy`、`cargo deny`、`cargo test` 流程可执行。
6. 更新本文件与 `log.md`。
产出：
1. 依赖边界检查工具或脚本
2. CI/本地执行说明文档

### P3-接口契约校准

目标：对照 `04-interfaces/*` 校准 Ports、Session/TargetAddr、错误模型与异步模型。
验收：接口偏差清单完成，修正路径明确。
详细任务：
1. 盘点 `sb-types` 的 Ports 与错误类型是否覆盖规范。
2. 检查 `Session` 与 `TargetAddr` 是否符合轻量与延迟解析要求。
3. 检查 `sb-core` 是否使用 typed errors，不引入 anyhow。
4. 检查 `async-trait` 使用是否在允许范围内。
5. 明确需新增/调整的 Ports 并同步文档。
6. 更新本文件与 `log.md`。
产出：
1. 接口偏差清单
2. 变更建议与实施顺序

### P4-模块归属与迁移

目标：完成协议/平台/控制面职责归位（按 `03-crates/*`）。
验收：sb-core 无协议/平台实现，sb-adapters/sb-platform/sb-api 职责清晰。
详细任务：
1. 逐项核对 sb-core 是否含协议实现、平台服务或控制面依赖。
2. 迁移协议实现至 sb-adapters。
3. 迁移平台服务至 sb-platform。
4. 迁移控制面 HTTP/gRPC 相关到 sb-api。
5. 调整 app 组合根注入逻辑与 feature 聚合。
6. 更新 `PROJECT_STRUCTURE_NAVIGATION.md`（如结构变化）。
7. 更新本文件与 `log.md`。
产出：
1. 迁移记录与变更摘要
2. 结构更新说明

### P5-测试与性能门禁

目标：对照测试策略与性能准则，形成可执行门禁与回归保护。
验收：分层测试策略可执行，热路径性能红线符合规范。
详细任务：
1. 对照 `testing-strategy.md` 划分并补齐测试层级。
2. 明确热路径，评估 enum 分发与分配策略。
3. 明确指标命名与采集点（见 `logging-metrics.md`）。
4. 建立性能回归检查（基准/阈值）。
5. 更新本文件与 `log.md`。
产出：
1. 测试执行清单与说明
2. 性能门禁说明与基线记录

## 当前进度记录（必须维护）

- P0-准备：已完成
- P1-边界审计：已完成（已确认）
- P2-依赖与构建门禁：进行中（本地门禁已执行，存在阻塞项；当前为增量测试策略；已新增 `tools/deny/` 离线执行入口）
- P3-接口契约校准：未开始
- P4-模块归属与迁移：未开始
- P5-测试与性能门禁：未开始

## 下一步（必须更新）

1. 完成 `cargo deny` 离线缓存预取（在线执行 `tools/deny/refresh.sh`），随后重试 `tools/deny/check.sh`。\n2. 继续处理 `cargo test` 权限限制导致的失败（必要时在受限环境跳过）。\n3. 继续按“增量测试”策略覆盖改动范围，并在合并前补全全量门禁记录。

## 关联日志

- 详见 `singbox_archspec_v2/08-refactor-tracking/log.md`
