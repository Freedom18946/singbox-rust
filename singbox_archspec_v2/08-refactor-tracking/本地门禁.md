# 本地门禁执行说明（P2）

> 说明：本文件记录本地质量门禁执行路径与实际结果（含离线限制）。

## 执行时间

- 2026-02-03

## 本地执行路径

1. 格式化检查：
   - `cargo fmt --all -- --check`
2. 代码检查：
   - `cargo clippy --workspace --all-targets -- -D warnings`
3. 依赖审计：
   - `cargo deny check`
4. 测试：
   - `cargo test --workspace`

## 执行结果摘要

1. `cargo fmt --all -- --check`
   - 结果：通过（已先执行 `cargo fmt --all` 应用格式化）

2. `cargo clippy --workspace --all-targets -- -D warnings`
   - 结果：通过

3. `cargo deny check`
   - 结果：失败
   - 主要原因：
     - 离线环境下 `cargo metadata` 缺少本地缓存依赖
   - 离线建议：
     - 联网时执行 `cargo fetch` 与 `cargo deny fetch`
     - 之后使用 `cargo deny --offline check`

4. `cargo test --workspace`
   - 结果：失败
   - 主要原因：
     - `sb-adapters` 单元测试中 Shadowsocks UDP 相关测试触发 `PermissionDenied`
     - 失败用例：`test_udp_packet_encryption_decryption`、`test_parse_address_length`、`test_udp_socket_address_encoding_domain`、`test_udp_socket_address_encoding_ipv4`

## 离线策略说明

- `cargo deny` 需要联网拉取依赖元数据；离线环境需提前缓存或使用离线镜像。
- `cargo clippy` / `cargo test` 会触发编译，若依赖未缓存则可能失败。

## 阻塞项

1. `cargo deny` 需要本地缓存或联网预取。
2. `cargo test` 受限环境中 Shadowsocks UDP 测试失败（需跳过或提供权限）。
