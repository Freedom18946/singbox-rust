# 本地门禁执行说明（P2）

> 说明：本文件记录本地质量门禁执行路径与实际结果（含离线限制）。

## 执行时间

- 2026-02-03

## 本地执行路径

1. 格式化检查：
   - `cargo fmt --all -- --check`
2. 代码检查：
   - `cargo clippy --workspace --all-targets -- -D warnings`
3. 依赖审计：
   - `tools/deny/check.sh`（离线，依赖本地缓存）
4. 测试：
   - `cargo test --workspace`

## 执行结果摘要

1. `cargo fmt --all -- --check`
   - 结果：通过（已先执行 `cargo fmt --all` 应用格式化）

2. `cargo clippy --workspace --all-targets -- -D warnings`
   - 结果：通过

3. `tools/deny/check.sh`
   - 结果：失败
   - 主要原因：
     - `cargo metadata` 在 `--offline` 下仍尝试下载缺失依赖（`windows-link`、`android_system_properties`），本地缓存不完整
   - 离线建议：
     - 联网时执行 `cargo fetch --locked` 与 `cargo deny fetch`
     - 之后使用 `tools/deny/check.sh`

4. `cargo test --workspace`
   - 结果：失败
   - 主要原因：
     - `sb-adapters` 单元测试中 Shadowsocks UDP 相关测试触发 `PermissionDenied`
     - 失败用例：`test_udp_packet_encryption_decryption`、`test_parse_address_length`、`test_udp_socket_address_encoding_domain`、`test_udp_socket_address_encoding_ipv4`

## 增量执行记录（临时策略）

- 2026-02-03：`cargo test -p sb-transport --test happy_eyeballs`（通过，6 passed，1 ignored）
- 2026-02-03：`cargo test -p sb-adapters --test shadowsocks_integration`（通过，0 tests）
- 2026-02-03：`cargo test -p sb-adapters --features adapter-shadowsocks test_udp_`（通过，3 passed）
- 2026-02-03：`cargo test -p sb-core udp_`（通过，32 passed）
- 2026-02-03：`cargo test -p sb-transport --test retry_integration`（先失败后修复并通过）
- 2026-02-03：`cargo test -p sb-transport --features transport_httpupgrade --test httpupgrade_integration`（通过，4 passed）
- 2026-02-03：`cargo test -p sb-transport --features transport_ws --test websocket_integration`（通过，4 passed）
- 2026-02-03：`cargo test -p sb-transport --features transport_h2 --test http2_integration`（通过，3 passed）
- 2026-02-03：`cargo test -p sb-transport --features transport_mux --test multiplex_integration`（通过，12 passed）

## 离线策略说明

- `cargo deny` 需要联网拉取依赖元数据；离线环境需提前缓存或使用离线镜像。
- `cargo clippy` / `cargo test` 会触发编译，若依赖未缓存则可能失败。
- 推荐在线预取：`tools/deny/refresh.sh`（含 `cargo fetch --locked` 与 `cargo deny fetch`）

## 阻塞项

1. `cargo deny` 需要本地缓存或联网预取。
2. `cargo test` 全量门禁未重跑；仅覆盖增量范围（合并前需补齐）。
