# P3 接口契约审计报告

生成时间：2026-02-06

## 审计依据

- `singbox_archspec_v2/04-interfaces/*`
- `singbox_archspec_v2/03-crates/sb-types.md`

---

## 偏差清单

### 1. Ports traits 重复定义（严重）

**规范要求**：所有 Ports traits 应定义在 `sb-types`

**实际情况**：`OutboundConnector` 在 5 处定义：

| 位置 | 方法签名 |
|------|----------|
| `sb-adapters/src/traits.rs:511` | `dial(target, opts) -> BoxedStream` |
| `sb-core/src/outbound/traits.rs:16` | `connect_tcp(ctx) -> TcpStream` |
| `sb-core/src/adapter/mod.rs:85` | （另一版本） |
| `sb-core/src/runtime/switchboard.rs:109` | （另一版本） |
| `sb-proto/src/connector.rs:116` | （另一版本） |

---

### 2. sb-types 缺失核心 Ports

**规范要求**：

- `InboundAcceptor`
- `OutboundConnector`
- `DnsPort`
- `AdminPort`
- `StatsPort`
- `MetricsPort`

**实际情况**：sb-types 仅包含 `IssueCode` 和 `IssuePayload`，无任何 Ports traits

---

### 3. Session/TargetAddr 位置错误

**规范要求**：在 `sb-types` 定义

**实际情况**：

- `SessionTable` 在 `sb-core/src/inbound/tun.rs:165`
- 无统一 `Session` 或 `TargetAddr` 类型

---

### 4. 协议实现在 sb-core（P4 违规）

**规范要求**：协议实现应在 `sb-adapters`

**实际情况**：sb-core 包含：

- `outbound/trojan.rs`
- `outbound/vless.rs`
- `outbound/shadowsocks.rs`
- `outbound/vmess.rs`

---

## 整改优先级

1. **P3.1**：在 `sb-types` 定义规范 Ports traits
2. **P3.2**：统一 `Session`, `TargetAddr` 到 `sb-types`
3. **P3.3**：创建 typed errors（`CoreError`, `DnsError` 等）
4. **P4**：迁移协议实现至 `sb-adapters`
