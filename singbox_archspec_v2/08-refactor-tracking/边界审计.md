# 边界审计报告（P1）

状态：初版完成（待确认）
最近更新：2026-02-03

## 依据规范

- `singbox_archspec_v2/01-constitution/dependency-constitution.md`
- `singbox_archspec_v2/05-reference/dependency-matrix.md`
- `singbox_archspec_v2/01-constitution/ci-enforcement.md`

## 审计范围

- Workspace members（`Cargo.toml`）
- direct dependencies（见 `依赖清单.md`）
- transitive dependencies（基于 `Cargo.lock`）

## 审计方法

1. 解析各 crate `Cargo.toml` 生成 direct dependency 清单。
2. 使用 `Cargo.lock` 推导 transitive dependency 清单（离线环境无法使用 `cargo metadata` 拉取依赖）。
3. 对照依赖宪法与依赖矩阵，标记违规与疑似违规。
4. 形成整改建议与影响评估。

## 发现与结论（初版）

1. 违规项：已确认 3 类，见“违规清单（确认）”。
2. 疑似违规项：已列出 3 类，需进一步确认范围与允许性。
3. 整改建议：已形成初版，见“整改建议（按优先级）”。

## 下一步

1. 请确认初版审计结果与整改建议。
2. 确认后进入 P2（依赖与构建门禁）。

## 违规清单（确认）

1. sb-core 直接依赖 Web/TLS/QUIC/HTTP/gRPC 相关库（axum、axum-server、hyper、reqwest、rustls、quinn、tokio-tungstenite、tonic、tower、h3/h3-quinn），违反 `dependency-constitution.md` 对 sb-core 禁止引入 Web/TLS/QUIC 大库的要求。证据：`crates/sb-core/Cargo.toml`。
2. sb-core 直接依赖 infra/平台/配置/指标 crates（sb-transport、sb-tls、sb-platform、sb-config、sb-metrics），违反依赖方向要求（sb-core 应仅依赖 sb-types/sb-common）。证据：`crates/sb-core/Cargo.toml`。
3. sb-adapters 直接依赖 sb-core（启用 router/v2ray_transport 等特性），违反依赖方向要求（adapters 不应反向依赖 core）。证据：`crates/sb-adapters/Cargo.toml`。

## 疑似违规或需确认

1. sb-transport 在 android 目标下依赖 sb-platform（`crates/sb-transport/Cargo.toml`），需确认 infra → platform 方向是否允许。
2. sb-api 直接依赖 sb-config（`crates/sb-api/Cargo.toml`），需确认控制面是否可直接解析配置或应由 app 注入 IR/原始配置。
3. sb-core 依赖 `anyhow` 与 `async-trait`（`crates/sb-core/Cargo.toml`），与 error-model/async-model 约束可能冲突，建议在 P3 进一步核查。

## 整改建议（按优先级）

1. 将 sb-core 中 Web/TLS/QUIC/HTTP/gRPC 相关依赖移出，归属至 sb-api（控制面）或 sb-adapters/sb-transport（协议与传输层），并改由 Ports/traits 交互。
2. 将 sb-core 对 sb-transport/sb-tls/sb-platform/sb-config/sb-metrics 的直接依赖移除，改为 app 组合根注入与 sb-types Ports；配置编译仅留在 sb-config，sb-core 只接收 IR。
3. 将 sb-adapters 对 sb-core 的依赖替换为 sb-types Ports/IR 或新建共享契约（仍归属 sb-types），避免反向依赖。
4. 对疑似违规项进行架构裁决，形成明确允许/禁止清单并同步到依赖矩阵与 CI 检查规则。

## 影响范围（初版）

1. 直接影响 crates：sb-core、sb-adapters、sb-api、sb-transport、sb-platform、sb-config、sb-metrics。
2. 影响 app 组合根与 feature 聚合方式（依赖注入路径与启用特性会调整）。
3. 影响路由与协议实现的依赖关系与测试布局（P3/P4/P5 将涉及测试与性能门禁调整）。

## 初步发现（direct dependencies）
说明：仅基于 direct dependencies（含 dev/build），未涵盖 transitive 与 feature 条件。
发现时间：2026-02-03 03:39

### sb-types
违规项：
1. (none)

### sb-core
违规项：
1. axum
2. h3
3. hyper
4. quinn
5. reqwest
6. rustls
7. tokio-tungstenite
8. tonic
9. tower

### sb-adapters
违规项：
1. sb-core

### sb-api
违规项：
1. (none)

### sb-platform
违规项：
1. (none)

### sb-transport
违规项：
1. (none)

### sb-tls
违规项：
1. (none)

### sb-runtime
违规项：
1. (none)

### sb-metrics
违规项：
1. (none)

### sb-security
违规项：
1. (none)

### sb-config
违规项：
1. (none)

### sb-common
违规项：
1. (none)

### sb-subscribe
违规项：
1. (none)

## 初步发现（transitive dependencies）
说明：基于 `Cargo.lock` 推导的 transitive 依赖。
发现时间：2026-02-03 03:40

### sb-types
违规项：
1. (none)

### sb-core
违规项：
1. axum
2. h2
3. hyper
4. reqwest
5. tonic
6. tower

### sb-api
违规项：
1. (none)

### sb-adapters
违规项：
1. (none)

### sb-platform
违规项：
1. (none)

### sb-transport
违规项：
1. (none)
