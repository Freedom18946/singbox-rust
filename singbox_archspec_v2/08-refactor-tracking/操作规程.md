# 重构标准化操作规程

> 本规程是执行约束。任何偏离必须记录在 `log.md` 并在 `整体进度规划.md` 中注明原因与补救计划。

## 0. 启动前（每次必做）

1. 阅读 `singbox_archspec_v2/08-refactor-tracking/整体进度规划.md`
2. 阅读本规程与 `singbox_archspec_v2/README.md`
3. 明确本次操作范围与目标，写入 `log.md`

## 1. 依赖与边界守则

- 依赖方向严格遵循 `01-constitution/dependency-constitution.md`
- 禁止在 sb-core 引入协议实现、平台服务或 Web/TLS/QUIC 大库
- 新增/调整依赖必须先登记在 `log.md` 并评估边界影响

## 2. 接口与错误模型

- Ports 必须来源于 `04-interfaces/*`，新增必须先更新 `sb-types` 与对应文档
- 错误模型遵循 `01-constitution/error-model.md`：core 不引入 anyhow
- 热路径优先 enum 分发（见 `01-constitution/async-model.md`）

## 3. 变更执行

- 任何改动必须有清晰的“依据规范”与“验收标准”
- 每次修改必须记录：文件清单、变更摘要、风险点
- 结构改动必须同步更新 `PROJECT_STRUCTURE_NAVIGATION.md`

## 4. 验证与收尾

- 依据 `01-constitution/testing-strategy.md` 选择合适层级测试
- 结果写入 `log.md`，并更新 `整体进度规划.md`
- 未通过的检查必须留下“下一步/阻塞项”记录

## 5. 必须记录的操作（最低要求）

- 任何文件读/写
- 任何命令执行（包含仅用于查看）
- 任何决策（如是否跳过测试、是否延后改造）
