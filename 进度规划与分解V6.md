
# 进度规划与分解V6（详版）
_更新时间：2025-09-21 05:42:32 Asia/Taipei_

> 准绳：Drop-in 替换 Go(sing-box 1.12.4)。六维一致性（CLI/配置/路由/协议/错误/发布）验收后方可切核。

## A. 当前真实进度盘点（据仓内文件与分析包）
- 仓结构：app + crates（sb-core/sb-adapters/sb-config/sb-transport/sb-metrics/...）已成型。
- 入站：HTTP/SOCKS/TUN 代码与测试样例存在。
- 出站：direct/http/socks、socks5-udp 实现存在；block/outbound glue 存在。
- 路由/Explain：判定核心在 sb-core，Explain 输出待统一 JSON 字段集。
- 配置：v1 兼容层齐；v2 严校验框架与错误码表存在，需锁死 IssueCode + ptr。
- UDP NAT：核心/指标文件存在，需补 map_size/evict/ttl_seconds/fail_class 全覆盖与压测脚本。
- 可观测：Prom 降噪逻辑与脚本存在；需完善指标目录与标签治理。
- 发布：sb-version 与 RC 清单需落库并纳入 CI。

## B. 里程碑
- M4 兼容性封口：配置/CLI/Explain/最小化守门/错误码表/Prom 降噪  
- M5 观测闭环+选择器：UDP NAT 指标闭环、选择器 behind env、DNS stub+cache（env）  
- M6 发行：RC 包完整与校验、Grafana 面板、跨平台打包

## C. WBS（逐任务·含触点·验收）
> 记法：交付/验收/触点/风险/预计人天（人天仅供排序，不作承诺）

### C1 Schema&错误（Owner: Config）
1. C1.1 schema-v2 错误格式锁死  
   交付：错误 JSON 固定字段集；IssueCode 枚举与 ptr。  
   验收：singbox check --schema-v2-validate 注入 UnknownField/TypeMismatch 用例全绿。  
   触点：crates/sb-config/src/*、crates/sb-core/src/error_map.rs、app/tests/check_cli.rs。  
   风险：历史兼容；缓解：v1 默认不变。  
   预计：2d

2. C1.2 --format json 输出 Schema 锁定  
   交付：run/check/route/version JSON 字段 Schema；CI 断言。  
   验收：Schema 变动触 CI 失败。  
   触点：app/src/bin/*、app/tests/*。  
   预计：1d

### C2 路由与工具（Owner: Router）
3. C2.1 minimize 守门（含 not_*）  
   交付：有否定维度时仅规范化；stderr 提示。  
   验收：带 not_domain 样例下，前后规则数不变、规范化一致。  
   触点：app/src/cli/check.rs、crates/sb-config/src/normalize.rs。  
   预计：1d

4. C2.2 route --explain JSON 固定  
   交付：固定字段集（dest, matched_rule, chain[], outbound）；RuleID=sha256-8。  
   验收：Go 与 Rust 输出比对工具通过。  
   触点：crates/sb-core/src/*explain*、app/src/cli/route.rs、tests/e2e_connect.rs。  
   预计：2d

### C3 UDP NAT（Owner: Transport/Core）
5. C3.1 指标补完  
   交付：map_size/evict_total{reason}/ttl_seconds；udp_upstream_fail_total{class}。  
   验收：压测脚本收敛；CI 中 P95 波动 < 5%。  
   触点：crates/sb-core/src/udp_*、crates/sb-metrics/src/*、tests/udp_*。  
   预计：3d

### C4 可观测（Owner: Metrics）
6. C4.1 Prom 降噪回归  
   交付：断网零噪声；失败分类归一。  
   验收：test_prometheus_robustness.sh 全绿。  
   触点：crates/sb-core/src/metrics/*、scripts/*。  
   预计：1d

7. C4.2 指标目录与标签治理  
   交付：METRICS_CATALOG.md 固定；新增标签登记流程。  
   验收：新增标签未经登记 CI 失败。  
   触点：crates/sb-metrics/*、docs。  
   预计：1d

### C5 发布（Owner: Release）
8. C5.1 sb-version 与 RC 清单  
   交付：singbox version --format json 输出；RC_MANIFEST.txt+校验脚本。  
   验收：RC 包可审计；CI 校验通过。  
   触点：app/src/bin/version.rs、scripts/release。  
   预计：1d

9. C5.2 跨平台打包与 CHANGELOG  
   交付：linux/windows/macos 包；CHANGELOG 注入。  
   验收：GUI 集成测试可直接替换。  
   触点：scripts/release、dist/*。  
   预计：2d

### C6 DNS（behind env · Owner: DNS）
10. C6.1 stub + cache  
    交付：缓存与回退策略；可开关。  
    验收：命中率/回退用例通过。  
    触点：crates/sb-core/src/dns*。  
    预计：2d

## D. 验收脚本清单（可直接运行）
- A1：Go vs Rust route --explain 一致性回放（样例集/比对脚本）。  
- A2：--schema-v2-validate 错误码/ptr 校验。  
- A3：UDP NAT 压测收敛曲线报告（导出 csv）。  
- A4：Prom 拉取失败降噪。  
- A5：RC 包校验（version-*.json + RC_MANIFEST.txt）。

## E. 风险与缓解
- 规则最小化误删 → 守门 + Explain 回放。  
- 指标标签爆炸 → 白名单与 CI 审核。  
- 发布不可审计 → sb-version + RC 清单校验。  
- 行为偏差 → 六维一致性门禁 + 回放测试。
